"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.LambdaStack = void 0;
const cdk = require("aws-cdk-lib");
const lambda = require("aws-cdk-lib/aws-lambda");
const aws_lambda_event_sources_1 = require("aws-cdk-lib/aws-lambda-event-sources");
const SQS = require("aws-cdk-lib/aws-sqs");
const aws_lambda_destinations_1 = require("aws-cdk-lib/aws-lambda-destinations");
class LambdaStack extends cdk.Stack {
    constructor(scope, id, props) {
        super(scope, id, props);
        const powertoolsLayer = lambda.LayerVersion.fromLayerVersionArn(this, "PowertoolsLayer", `arn:aws:lambda:${cdk.Stack.of(this).region}:094274105915:layer:AWSLambdaPowertoolsTypeScript:18`);
        const dlq = new SQS.Queue(this, "dlq");
        const queueConsumer = new lambda.Function(this, "consumerFunction", {
            handler: "queueConsumer.main",
            runtime: lambda.Runtime.NODEJS_14_X,
            code: lambda.Code.fromAsset("src"),
            environment: {
                TABLE_NAME: props.ddbTable.tableName,
                QUEUE_NAME: props.queue.queueName,
                QUEUE_URL: props.queue.queueUrl,
                // test: props.targetLambda.functionName
            },
            layers: [powertoolsLayer],
            onFailure: new aws_lambda_destinations_1.SqsDestination(dlq),
        });
        const process_order = new lambda.Function(this, "processOrder", {
            handler: "processOrder.main",
            runtime: lambda.Runtime.NODEJS_14_X,
            code: lambda.Code.fromAsset("src"),
            environment: {
                TABLE_NAME: props.ddbTable.tableName,
                QUEUE_NAME: props.queue.queueName,
                QUEUE_URL: props.queue.queueUrl,
            },
            layers: [powertoolsLayer],
        });
        process_order.addEventSource(new aws_lambda_event_sources_1.DynamoEventSource(props.ddbTable, {
            startingPosition: lambda.StartingPosition.LATEST,
        }));
        props.ddbTable.grantStreamRead(process_order);
        props.ddbTable.grantReadWriteData(process_order);
        const streamConsumer = new lambda.Function(this, "streamConsumer", {
            handler: "streamConsumer.main",
            runtime: lambda.Runtime.NODEJS_14_X,
            code: lambda.Code.fromAsset("src"),
            environment: {
                TABLE_NAME: props.ddbTable.tableName,
                QUEUE_NAME: props.queue.queueName,
                QUEUE_URL: props.queue.queueUrl,
            },
            layers: [powertoolsLayer],
            role: queueConsumer.role,
        });
        streamConsumer.addEventSource(new aws_lambda_event_sources_1.DynamoEventSource(props.ddbTable, {
            startingPosition: lambda.StartingPosition.LATEST,
        }));
        queueConsumer.addEventSource(new aws_lambda_event_sources_1.SqsEventSource(props.queue));
        props.queue.grantConsumeMessages(queueConsumer);
        props.queue.grantSendMessages(streamConsumer);
        props.ddbTable.grantReadWriteData(queueConsumer);
        props.ddbTable.grantStreamRead(streamConsumer);
        props.ddbTable.grantReadWriteData(streamConsumer);
    }
}
exports.LambdaStack = LambdaStack;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibGFtYmRhU3RhY2suanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJsYW1iZGFTdGFjay50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSxtQ0FBbUM7QUFDbkMsaURBQWlEO0FBQ2pELG1GQUc4QztBQUc5QywyQ0FBMkM7QUFDM0MsaUZBQXFFO0FBUXJFLE1BQWEsV0FBWSxTQUFRLEdBQUcsQ0FBQyxLQUFLO0lBQ3hDLFlBQVksS0FBZ0IsRUFBRSxFQUFVLEVBQUUsS0FBdUI7UUFDL0QsS0FBSyxDQUFDLEtBQUssRUFBRSxFQUFFLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFFeEIsTUFBTSxlQUFlLEdBQUcsTUFBTSxDQUFDLFlBQVksQ0FBQyxtQkFBbUIsQ0FDN0QsSUFBSSxFQUNKLGlCQUFpQixFQUNqQixrQkFDRSxHQUFHLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsQ0FBQyxNQUNyQixzREFBc0QsQ0FDdkQsQ0FBQztRQUNGLE1BQU0sR0FBRyxHQUFHLElBQUksR0FBRyxDQUFDLEtBQUssQ0FBQyxJQUFJLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFFdkMsTUFBTSxhQUFhLEdBQUcsSUFBSSxNQUFNLENBQUMsUUFBUSxDQUFDLElBQUksRUFBRSxrQkFBa0IsRUFBRTtZQUNsRSxPQUFPLEVBQUUsb0JBQW9CO1lBQzdCLE9BQU8sRUFBRSxNQUFNLENBQUMsT0FBTyxDQUFDLFdBQVc7WUFDbkMsSUFBSSxFQUFFLE1BQU0sQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQztZQUNsQyxXQUFXLEVBQUU7Z0JBQ1gsVUFBVSxFQUFFLEtBQUssQ0FBQyxRQUFRLENBQUMsU0FBUztnQkFDcEMsVUFBVSxFQUFFLEtBQUssQ0FBQyxLQUFLLENBQUMsU0FBUztnQkFDakMsU0FBUyxFQUFFLEtBQUssQ0FBQyxLQUFLLENBQUMsUUFBUTtnQkFDL0Isd0NBQXdDO2FBQ3pDO1lBQ0QsTUFBTSxFQUFFLENBQUMsZUFBZSxDQUFDO1lBQ3pCLFNBQVMsRUFBRSxJQUFJLHdDQUFjLENBQUMsR0FBRyxDQUFDO1NBQ25DLENBQUMsQ0FBQztRQUVILE1BQU0sYUFBYSxHQUFHLElBQUksTUFBTSxDQUFDLFFBQVEsQ0FBQyxJQUFJLEVBQUUsY0FBYyxFQUFFO1lBQzlELE9BQU8sRUFBRSxtQkFBbUI7WUFDNUIsT0FBTyxFQUFFLE1BQU0sQ0FBQyxPQUFPLENBQUMsV0FBVztZQUNuQyxJQUFJLEVBQUUsTUFBTSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDO1lBQ2xDLFdBQVcsRUFBRTtnQkFDWCxVQUFVLEVBQUUsS0FBSyxDQUFDLFFBQVEsQ0FBQyxTQUFTO2dCQUNwQyxVQUFVLEVBQUUsS0FBSyxDQUFDLEtBQUssQ0FBQyxTQUFTO2dCQUNqQyxTQUFTLEVBQUUsS0FBSyxDQUFDLEtBQUssQ0FBQyxRQUFRO2FBQ2hDO1lBQ0QsTUFBTSxFQUFFLENBQUMsZUFBZSxDQUFDO1NBQzFCLENBQUMsQ0FBQztRQUNILGFBQWEsQ0FBQyxjQUFjLENBQzFCLElBQUksNENBQWlCLENBQUMsS0FBSyxDQUFDLFFBQVEsRUFBRTtZQUNwQyxnQkFBZ0IsRUFBRSxNQUFNLENBQUMsZ0JBQWdCLENBQUMsTUFBTTtTQUNqRCxDQUFDLENBQ0gsQ0FBQztRQUVGLEtBQUssQ0FBQyxRQUFRLENBQUMsZUFBZSxDQUFDLGFBQWEsQ0FBQyxDQUFDO1FBQzlDLEtBQUssQ0FBQyxRQUFRLENBQUMsa0JBQWtCLENBQUMsYUFBYSxDQUFDLENBQUM7UUFFakQsTUFBTSxjQUFjLEdBQUcsSUFBSSxNQUFNLENBQUMsUUFBUSxDQUFDLElBQUksRUFBRSxnQkFBZ0IsRUFBRTtZQUNqRSxPQUFPLEVBQUUscUJBQXFCO1lBQzlCLE9BQU8sRUFBRSxNQUFNLENBQUMsT0FBTyxDQUFDLFdBQVc7WUFDbkMsSUFBSSxFQUFFLE1BQU0sQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQztZQUNsQyxXQUFXLEVBQUU7Z0JBQ1gsVUFBVSxFQUFFLEtBQUssQ0FBQyxRQUFRLENBQUMsU0FBUztnQkFDcEMsVUFBVSxFQUFFLEtBQUssQ0FBQyxLQUFLLENBQUMsU0FBUztnQkFDakMsU0FBUyxFQUFFLEtBQUssQ0FBQyxLQUFLLENBQUMsUUFBUTthQUNoQztZQUNELE1BQU0sRUFBRSxDQUFDLGVBQWUsQ0FBQztZQUN6QixJQUFJLEVBQUUsYUFBYSxDQUFDLElBQUk7U0FDekIsQ0FBQyxDQUFDO1FBRUgsY0FBYyxDQUFDLGNBQWMsQ0FDM0IsSUFBSSw0Q0FBaUIsQ0FBQyxLQUFLLENBQUMsUUFBUSxFQUFFO1lBQ3BDLGdCQUFnQixFQUFFLE1BQU0sQ0FBQyxnQkFBZ0IsQ0FBQyxNQUFNO1NBQ2pELENBQUMsQ0FDSCxDQUFDO1FBRUYsYUFBYSxDQUFDLGNBQWMsQ0FBQyxJQUFJLHlDQUFjLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUM7UUFFOUQsS0FBSyxDQUFDLEtBQUssQ0FBQyxvQkFBb0IsQ0FBQyxhQUFhLENBQUMsQ0FBQztRQUNoRCxLQUFLLENBQUMsS0FBSyxDQUFDLGlCQUFpQixDQUFDLGNBQWMsQ0FBQyxDQUFDO1FBQzlDLEtBQUssQ0FBQyxRQUFRLENBQUMsa0JBQWtCLENBQUMsYUFBYSxDQUFDLENBQUM7UUFDakQsS0FBSyxDQUFDLFFBQVEsQ0FBQyxlQUFlLENBQUMsY0FBYyxDQUFDLENBQUM7UUFDL0MsS0FBSyxDQUFDLFFBQVEsQ0FBQyxrQkFBa0IsQ0FBQyxjQUFjLENBQUMsQ0FBQztJQUNwRCxDQUFDO0NBQ0Y7QUExRUQsa0NBMEVDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgY2RrIGZyb20gXCJhd3MtY2RrLWxpYlwiO1xuaW1wb3J0ICogYXMgbGFtYmRhIGZyb20gXCJhd3MtY2RrLWxpYi9hd3MtbGFtYmRhXCI7XG5pbXBvcnQge1xuICBEeW5hbW9FdmVudFNvdXJjZSxcbiAgU3FzRXZlbnRTb3VyY2UsXG59IGZyb20gXCJhd3MtY2RrLWxpYi9hd3MtbGFtYmRhLWV2ZW50LXNvdXJjZXNcIjtcbmltcG9ydCB7IENvbnN0cnVjdCB9IGZyb20gXCJjb25zdHJ1Y3RzXCI7XG5pbXBvcnQgKiBhcyBEeW5hbW9kYiBmcm9tIFwiYXdzLWNkay1saWIvYXdzLWR5bmFtb2RiXCI7XG5pbXBvcnQgKiBhcyBTUVMgZnJvbSBcImF3cy1jZGstbGliL2F3cy1zcXNcIjtcbmltcG9ydCB7IFNxc0Rlc3RpbmF0aW9uIH0gZnJvbSBcImF3cy1jZGstbGliL2F3cy1sYW1iZGEtZGVzdGluYXRpb25zXCI7XG5cbi8vIGltcG9ydCB7Q2RrSW1zUHJvamVjdFN0YWNrfSBmcm9tICcuLi9jZGstaW1zLXByb2plY3Qtc3RhY2snO1xuXG5pbnRlcmZhY2UgTGFtYmRhU3RhY2tQcm9wcyBleHRlbmRzIGNkay5TdGFja1Byb3BzIHtcbiAgZGRiVGFibGU6IER5bmFtb2RiLlRhYmxlO1xuICBxdWV1ZTogU1FTLlF1ZXVlO1xufVxuZXhwb3J0IGNsYXNzIExhbWJkYVN0YWNrIGV4dGVuZHMgY2RrLlN0YWNrIHtcbiAgY29uc3RydWN0b3Ioc2NvcGU6IENvbnN0cnVjdCwgaWQ6IHN0cmluZywgcHJvcHM6IExhbWJkYVN0YWNrUHJvcHMpIHtcbiAgICBzdXBlcihzY29wZSwgaWQsIHByb3BzKTtcblxuICAgIGNvbnN0IHBvd2VydG9vbHNMYXllciA9IGxhbWJkYS5MYXllclZlcnNpb24uZnJvbUxheWVyVmVyc2lvbkFybihcbiAgICAgIHRoaXMsXG4gICAgICBcIlBvd2VydG9vbHNMYXllclwiLFxuICAgICAgYGFybjphd3M6bGFtYmRhOiR7XG4gICAgICAgIGNkay5TdGFjay5vZih0aGlzKS5yZWdpb25cbiAgICAgIH06MDk0Mjc0MTA1OTE1OmxheWVyOkFXU0xhbWJkYVBvd2VydG9vbHNUeXBlU2NyaXB0OjE4YFxuICAgICk7XG4gICAgY29uc3QgZGxxID0gbmV3IFNRUy5RdWV1ZSh0aGlzLCBcImRscVwiKTtcblxuICAgIGNvbnN0IHF1ZXVlQ29uc3VtZXIgPSBuZXcgbGFtYmRhLkZ1bmN0aW9uKHRoaXMsIFwiY29uc3VtZXJGdW5jdGlvblwiLCB7XG4gICAgICBoYW5kbGVyOiBcInF1ZXVlQ29uc3VtZXIubWFpblwiLFxuICAgICAgcnVudGltZTogbGFtYmRhLlJ1bnRpbWUuTk9ERUpTXzE0X1gsXG4gICAgICBjb2RlOiBsYW1iZGEuQ29kZS5mcm9tQXNzZXQoXCJzcmNcIiksXG4gICAgICBlbnZpcm9ubWVudDoge1xuICAgICAgICBUQUJMRV9OQU1FOiBwcm9wcy5kZGJUYWJsZS50YWJsZU5hbWUsXG4gICAgICAgIFFVRVVFX05BTUU6IHByb3BzLnF1ZXVlLnF1ZXVlTmFtZSxcbiAgICAgICAgUVVFVUVfVVJMOiBwcm9wcy5xdWV1ZS5xdWV1ZVVybCxcbiAgICAgICAgLy8gdGVzdDogcHJvcHMudGFyZ2V0TGFtYmRhLmZ1bmN0aW9uTmFtZVxuICAgICAgfSxcbiAgICAgIGxheWVyczogW3Bvd2VydG9vbHNMYXllcl0sXG4gICAgICBvbkZhaWx1cmU6IG5ldyBTcXNEZXN0aW5hdGlvbihkbHEpLFxuICAgIH0pO1xuXG4gICAgY29uc3QgcHJvY2Vzc19vcmRlciA9IG5ldyBsYW1iZGEuRnVuY3Rpb24odGhpcywgXCJwcm9jZXNzT3JkZXJcIiwge1xuICAgICAgaGFuZGxlcjogXCJwcm9jZXNzT3JkZXIubWFpblwiLFxuICAgICAgcnVudGltZTogbGFtYmRhLlJ1bnRpbWUuTk9ERUpTXzE0X1gsXG4gICAgICBjb2RlOiBsYW1iZGEuQ29kZS5mcm9tQXNzZXQoXCJzcmNcIiksXG4gICAgICBlbnZpcm9ubWVudDoge1xuICAgICAgICBUQUJMRV9OQU1FOiBwcm9wcy5kZGJUYWJsZS50YWJsZU5hbWUsXG4gICAgICAgIFFVRVVFX05BTUU6IHByb3BzLnF1ZXVlLnF1ZXVlTmFtZSxcbiAgICAgICAgUVVFVUVfVVJMOiBwcm9wcy5xdWV1ZS5xdWV1ZVVybCxcbiAgICAgIH0sXG4gICAgICBsYXllcnM6IFtwb3dlcnRvb2xzTGF5ZXJdLFxuICAgIH0pO1xuICAgIHByb2Nlc3Nfb3JkZXIuYWRkRXZlbnRTb3VyY2UoXG4gICAgICBuZXcgRHluYW1vRXZlbnRTb3VyY2UocHJvcHMuZGRiVGFibGUsIHtcbiAgICAgICAgc3RhcnRpbmdQb3NpdGlvbjogbGFtYmRhLlN0YXJ0aW5nUG9zaXRpb24uTEFURVNULFxuICAgICAgfSlcbiAgICApO1xuXG4gICAgcHJvcHMuZGRiVGFibGUuZ3JhbnRTdHJlYW1SZWFkKHByb2Nlc3Nfb3JkZXIpO1xuICAgIHByb3BzLmRkYlRhYmxlLmdyYW50UmVhZFdyaXRlRGF0YShwcm9jZXNzX29yZGVyKTtcblxuICAgIGNvbnN0IHN0cmVhbUNvbnN1bWVyID0gbmV3IGxhbWJkYS5GdW5jdGlvbih0aGlzLCBcInN0cmVhbUNvbnN1bWVyXCIsIHtcbiAgICAgIGhhbmRsZXI6IFwic3RyZWFtQ29uc3VtZXIubWFpblwiLFxuICAgICAgcnVudGltZTogbGFtYmRhLlJ1bnRpbWUuTk9ERUpTXzE0X1gsXG4gICAgICBjb2RlOiBsYW1iZGEuQ29kZS5mcm9tQXNzZXQoXCJzcmNcIiksXG4gICAgICBlbnZpcm9ubWVudDoge1xuICAgICAgICBUQUJMRV9OQU1FOiBwcm9wcy5kZGJUYWJsZS50YWJsZU5hbWUsXG4gICAgICAgIFFVRVVFX05BTUU6IHByb3BzLnF1ZXVlLnF1ZXVlTmFtZSxcbiAgICAgICAgUVVFVUVfVVJMOiBwcm9wcy5xdWV1ZS5xdWV1ZVVybCxcbiAgICAgIH0sXG4gICAgICBsYXllcnM6IFtwb3dlcnRvb2xzTGF5ZXJdLFxuICAgICAgcm9sZTogcXVldWVDb25zdW1lci5yb2xlLFxuICAgIH0pO1xuXG4gICAgc3RyZWFtQ29uc3VtZXIuYWRkRXZlbnRTb3VyY2UoXG4gICAgICBuZXcgRHluYW1vRXZlbnRTb3VyY2UocHJvcHMuZGRiVGFibGUsIHtcbiAgICAgICAgc3RhcnRpbmdQb3NpdGlvbjogbGFtYmRhLlN0YXJ0aW5nUG9zaXRpb24uTEFURVNULFxuICAgICAgfSlcbiAgICApO1xuXG4gICAgcXVldWVDb25zdW1lci5hZGRFdmVudFNvdXJjZShuZXcgU3FzRXZlbnRTb3VyY2UocHJvcHMucXVldWUpKTtcblxuICAgIHByb3BzLnF1ZXVlLmdyYW50Q29uc3VtZU1lc3NhZ2VzKHF1ZXVlQ29uc3VtZXIpO1xuICAgIHByb3BzLnF1ZXVlLmdyYW50U2VuZE1lc3NhZ2VzKHN0cmVhbUNvbnN1bWVyKTtcbiAgICBwcm9wcy5kZGJUYWJsZS5ncmFudFJlYWRXcml0ZURhdGEocXVldWVDb25zdW1lcik7XG4gICAgcHJvcHMuZGRiVGFibGUuZ3JhbnRTdHJlYW1SZWFkKHN0cmVhbUNvbnN1bWVyKTtcbiAgICBwcm9wcy5kZGJUYWJsZS5ncmFudFJlYWRXcml0ZURhdGEoc3RyZWFtQ29uc3VtZXIpO1xuICB9XG59XG4iXX0=